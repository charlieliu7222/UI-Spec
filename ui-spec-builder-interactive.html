<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI Spec Builder Pro - 完整版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        h2 {
            font-size: 16px;
            margin: 20px 0 12px 0;
            color: #374151;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #4b5563;
        }
        
        input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        textarea {
            width: 100%;
            font-family: 'Courier New', monospace;
            min-height: 400px;
            resize: vertical;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
        }
        
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-right: 6px;
            margin-bottom: 6px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #1d4ed8;
        }
        
        button.secondary {
            background: #6b7280;
        }
        
        button.secondary:hover {
            background: #4b5563;
        }
        
        button.small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* 組件分類 */
        .component-category {
            margin-bottom: 16px;
            padding: 14px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .category-title {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .component-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .component-buttons button {
            margin: 0;
        }
        
        .output-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
        }
        
        .output-tabs button {
            background: transparent;
            color: #6b7280;
            border: none;
            border-bottom: 2px solid transparent;
            margin: 0 0 -2px 0;
            padding: 10px 16px;
            border-radius: 0;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .output-tabs button.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            font-weight: 600;
        }
        
        .output-content {
            display: none;
        }
        
        .output-content.active {
            display: block;
        }
        
        pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .action-buttons {
            margin-bottom: 12px;
            display: flex;
            gap: 8px;
        }
        
        .help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .quick-examples {
            background: #f0f9ff;
            padding: 12px;
            border-radius: 6px;
            margin-top: 16px;
            border: 1px solid #bfdbfe;
        }
        
        .quick-examples h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #1e40af;
        }
        
        .scrollable {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        /* 滾動條樣式 */
        .scrollable::-webkit-scrollbar {
            width: 8px;
        }
        
        .scrollable::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .scrollable::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .scrollable::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            background: #10b981;
            color: white;
            font-size: 11px;
            border-radius: 12px;
            margin-left: 6px;
            font-weight: 500;
        }

        /* 互動功能面板樣式 */
        .interaction-panel {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .interaction-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .interaction-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .interaction-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            text-align: left;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .interaction-btn:hover {
            background: #dbeafe;
            border-color: #3b82f6;
            transform: translateY(-1px);
        }

        .interaction-btn.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .interaction-icon {
            font-size: 16px;
        }

        .selection-info {
            background: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #92400e;
        }

        .selection-info.hidden {
            display: none;
        }

        .quick-actions {
            display: flex;
            gap: 6px;
            margin-top: 12px;
        }

        .quick-actions button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }

        /* 功能標籤樣式 */
        .function-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 4px;
            font-family: 'Courier New', monospace;
        }

        .stats {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #6b7280;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .copy-success {
            background: #10b981 !important;
        }

        /* 視覺化專用樣式 - ASCII 版本 */
        .visual-container {
            width: 100%;
            min-height: 500px;
            background: #1f2937;
            padding: 24px;
            border-radius: 8px;
            border: 2px solid #374151;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            color: #f3f4f6;
            white-space: pre;
            overflow-x: auto;
            resize: vertical;
        }
        
        .visual-container:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .visual-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .visual-row {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 16px;
        }

        .visual-box {
            flex: 1;
            min-height: 60px;
            border: 2px solid #2563eb;
            border-radius: 6px;
            padding: 12px;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #1f2937;
            font-family: 'Courier New', monospace;
        }

        .visual-box.nested {
            min-height: 100px;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            gap: 8px;
        }

        .visual-nested-item {
            background: white;
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 13px;
        }

        .visual-arrow {
            color: #2563eb;
            font-size: 18px;
            font-weight: bold;
        }

        .visual-description {
            flex: 0 0 200px;
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel: Component Selector -->
        <div class="panel">
            <h1>🎨 UI Spec Builder <span class="badge">Pro</span></h1>
            
            <div class="form-group">
                <label>頁面名稱</label>
                <input type="text" id="pageName" value="我的第一次" placeholder="例如：使用者管理頁面">
            </div>
            
            <h2>📦 選擇組件</h2>
            <div class="help-text">💡 點擊下方按鈕添加組件到右側結構</div>
            
            <!-- 互動功能面板 -->
            <div class="interaction-panel">
                <div class="interaction-title">
                    ⚡ 互動功能
                </div>
                <div class="selection-info hidden" id="selectionInfo">
                    📍 未選擇任何行
                </div>
                <div class="interaction-grid">
                    <button class="interaction-btn" onclick="addInteraction('onClick')">
                        <span class="interaction-icon">👆</span>
                        <span>onClick</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onChange')">
                        <span class="interaction-icon">🔄</span>
                        <span>onChange</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onSubmit')">
                        <span class="interaction-icon">📤</span>
                        <span>onSubmit</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onHover')">
                        <span class="interaction-icon">👋</span>
                        <span>onHover</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onFocus')">
                        <span class="interaction-icon">🎯</span>
                        <span>onFocus</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onBlur')">
                        <span class="interaction-icon">👁️</span>
                        <span>onBlur</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onKeyPress')">
                        <span class="interaction-icon">⌨️</span>
                        <span>onKeyPress</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onScroll')">
                        <span class="interaction-icon">📜</span>
                        <span>onScroll</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onLoad')">
                        <span class="interaction-icon">⏳</span>
                        <span>onLoad</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onError')">
                        <span class="interaction-icon">⚠️</span>
                        <span>onError</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onResize')">
                        <span class="interaction-icon">↔️</span>
                        <span>onResize</span>
                    </button>
                    <button class="interaction-btn" onclick="addInteraction('onDrag')">
                        <span class="interaction-icon">🖱️</span>
                        <span>onDrag</span>
                    </button>
                </div>
                <div class="quick-actions">
                    <button class="secondary small" onclick="removeInteractions()">🗑️ 清除功能</button>
                    <button class="small" onclick="highlightSelection()">📍 定位選擇</button>
                </div>
                <div class="help-text" style="margin-top: 8px;">
                    💡 在右側結構中點擊或選中文字，然後點擊上方按鈕添加功能
                </div>
            </div>
            
            <div class="scrollable">
                <!-- 佈局容器 -->
                <div class="component-category">
                    <div class="category-title">📐 佈局容器</div>
                    <div class="component-buttons">
                        <button class="small" onclick="addComponent('Header')">Header</button>
                        <button class="small" onclick="addComponent('Toolbar')">Toolbar</button>
                        <button class="small" onclick="addComponent('Sidebar')">Sidebar</button>
                        <button class="small" onclick="addComponent('Content')">Content</button>
                        <button class="small" onclick="addComponent('Footer')">Footer</button>
                        <button class="small" onclick="addComponent('Container')">Container</button>
                        <button class="small" onclick="addComponent('Grid')">Grid</button>
                        <button class="small" onclick="addComponent('Flex')">Flex</button>
                    </div>
                </div>

                <!-- 基礎組件 -->
                <div class="component-category">
                    <div class="category-title">🔘 基礎組件</div>
                    <div class="component-buttons">
                        <button class="small" onclick="addComponent('Button')">Button</button>
                        <button class="small" onclick="addComponent('Input')">Input</button>
                        <button class="small" onclick="addComponent('Textarea')">Textarea</button>
                        <button class="small" onclick="addComponent('Select')">Select</button>
                        <button class="small" onclick="addComponent('Checkbox')">Checkbox</button>
                        <button class="small" onclick="addComponent('Radio')">Radio</button>
                        <button class="small" onclick="addComponent('Switch')">Switch</button>
                        <button class="small" onclick="addComponent('Slider')">Slider</button>
                    </div>
                </div>

                <!-- 導航組件 -->
                <div class="component-category">
                    <div class="category-title">🧭 導航組件</div>
                    <div class="component-buttons">
                        <button class="small" onclick="addComponent('Navbar')">Navbar</button>
                        <button class="small" onclick="addComponent('Menu')">Menu</button>
                        <button class="small" onclick="addComponent('Tabs')">Tabs</button>
                        <button class="small" onclick="addComponent('Breadcrumb')">Breadcrumb</button>
                        <button class="small" onclick="addComponent('Pagination')">Pagination</button>
                        <button class="small" onclick="addComponent('Stepper')">Stepper</button>
                    </div>
                </div>

                <!-- 數據展示 -->
                <div class="component-category">
                    <div class="category-title">📊 數據展示</div>
                    <div class="component-buttons">
                        <button class="small" onclick="addComponent('Table')">Table</button>
                        <button class="small" onclick="addComponent('List')">List</button>
                        <button class="small" onclick="addComponent('Card')">Card</button>
                        <button class="small" onclick="addComponent('Avatar')">Avatar</button>
                        <button class="small" onclick="addComponent('Badge')">Badge</button>
                        <button class="small" onclick="addComponent('Chip')">Chip</button>
                        <button class="small" onclick="addComponent('Tag')">Tag</button>
                        <button class="small" onclick="addComponent('Timeline')">Timeline</button>
                    </div>
                </div>

                <!-- 反饋組件 -->
                <div class="component-category">
                    <div class="category-title">💬 反饋組件</div>
                    <div class="component-buttons">
                        <button class="small" onclick="addComponent('Alert')">Alert</button>
                        <button class="small" onclick="addComponent('Toast')">Toast</button>
                        <button class="small" onclick="addComponent('Modal')">Modal</button>
                        <button class="small" onclick="addComponent('Drawer')">Drawer</button>
                        <button class="small" onclick="addComponent('Tooltip')">Tooltip</button>
                        <button class="small" onclick="addComponent('Popover')">Popover</button>
                        <button class="small" onclick="addComponent('Progress')">Progress</button>
                        <button class="small" onclick="addComponent('Spinner')">Spinner</button>
                        <button class="small" onclick="addComponent('Skeleton')">Skeleton</button>
                    </div>
                </div>

                <!-- 其他組件 -->
                <div class="component-category">
                    <div class="category-title">🎯 其他組件</div>
                    <div class="component-buttons">
                        <button class="small" onclick="addComponent('Dropdown')">Dropdown</button>
                        <button class="small" onclick="addComponent('Accordion')">Accordion</button>
                        <button class="small" onclick="addComponent('Carousel')">Carousel</button>
                        <button class="small" onclick="addComponent('Divider')">Divider</button>
                        <button class="small" onclick="addComponent('Icon')">Icon</button>
                        <button class="small" onclick="addComponent('Image')">Image</button>
                        <button class="small" onclick="addComponent('Video')">Video</button>
                        <button class="small" onclick="addComponent('Form')">Form</button>
                    </div>
                </div>
            </div>
            
            <div class="quick-examples">
                <h3>📝 快速範例</h3>
                <button class="small" onclick="loadExample('login')">登入頁面</button>
                <button class="small" onclick="loadExample('dashboard')">儀表板</button>
                <button class="small" onclick="loadExample('form')">表單頁面</button>
                <button class="small" onclick="loadExample('ecommerce')">電商頁面</button>
                <button class="small" onclick="loadExample('admin')">後台系統</button>
            </div>
        </div>
        
        <!-- Right Panel: Structure & Output -->
        <div class="panel">
            <h1>📋 結構 & 輸出</h1>
            
            <div class="output-tabs">
                <button class="active" onclick="switchTab('structure')">✏️ 目前結構</button>
                <button onclick="switchTab('visual')">🎨 視覺化</button>
                <button onclick="switchTab('ascii')">📐 ASCII</button>
                <button onclick="switchTab('spec')">🤖 AI規格</button>
                <button onclick="switchTab('json')">{ } JSON</button>
                <button onclick="switchTab('gherkin')">🥒 Gherkin</button>
            </div>
            
            <!-- 目前結構 -->
            <div id="structure-output" class="output-content active">
                <div class="stats">
                    <div class="stat-item">
                        <span>📊</span>
                        <span id="line-count">0 行</span>
                    </div>
                    <div class="stat-item">
                        <span>🎯</span>
                        <span id="component-count">0 組件</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button onclick="generateSpec()">🚀 產生規格</button>
                    <button class="secondary" onclick="clearAll()">🗑️ 清空</button>
                    <button class="secondary" onclick="undo()">↶ 復原</button>
                </div>
                <textarea id="structure" placeholder="點擊左側按鈕添加組件...&#10;&#10;或直接在這裡編輯結構：&#10;├─ Header&#10;  ├─ Button: &quot;按鈕&quot; (primary)&#10;├─ Content&#10;  ├─ Card">├─ Header (固定在頂部)
├─ Toolbar (操作區)
├─ Toggle Switch: "啟用功能"
├─ Checkbox: "同意條款"
├─ Container (max-width: 1200px)
├─ Flex Container (justify: space-between, align: center)
├─ Content (主要內容)
├─ Content (主要內容)
├─ Content (主要內容)
├─ Content (主要內容)
├─ Content (主要內容)
├─ Content (主要內容)
├─ Drawer (position: right, width: 400px)
├─ Modal Dialog (title: "標題", width: 500px)
├─ Tooltip: "提示文字"</textarea>
                <div class="help-text">💡 提示：你也可以直接編輯這裡的內容</div>
            </div>

            <!-- 頁面結構視覺化 -->
            <div id="visual-output" class="output-content">
                <div class="action-buttons">
                    <button onclick="copyOutput('visual')">📋 複製</button>
                    <button onclick="syncFromVisual()">⬅️ 同步到結構</button>
                    <button onclick="exportVisualASCII()">💾 匯出</button>
                    <button onclick="refreshVisual()">🔄 重新生成</button>
                </div>
                <textarea id="visual-container" class="visual-container" spellcheck="false" placeholder="點擊「產生規格」按鈕生成 ASCII 視覺圖，然後你可以直接編輯..."></textarea>
                <div class="help-text">
                    💡 提示：可直接編輯 ASCII 圖，使用 ╔═╗║╚╝ ┌─┐│└┘ 等字符繪製。編輯後點擊「同步到結構」更新左側輸入。
                </div>
            </div>
            
            <!-- ASCII 圖 -->
            <div id="ascii-output" class="output-content">
                <div class="action-buttons">
                    <button onclick="copyOutput('ascii')">📋 複製</button>
                </div>
                <pre id="ascii-pre">點擊「產生規格」按鈕查看結果...</pre>
            </div>
            
            <!-- AI 規格 -->
            <div id="spec-output" class="output-content">
                <div class="action-buttons">
                    <button onclick="copyOutput('spec')">📋 複製</button>
                </div>
                <pre id="spec-pre">點擊「產生規格」按鈕查看結果...</pre>
            </div>
            
            <!-- JSON -->
            <div id="json-output" class="output-content">
                <div class="action-buttons">
                    <button onclick="copyOutput('json')">📋 複製</button>
                </div>
                <pre id="json-pre">點擊「產生規格」按鈕查看結果...</pre>
            </div>

            <!-- Gherkin -->
            <div id="gherkin-output" class="output-content">
                <div class="action-buttons">
                    <button onclick="copyOutput('gherkin')">📋 複製</button>
                </div>
                <pre id="gherkin-pre">點擊「產生規格」按鈕查看結果...</pre>
            </div>
        </div>
    </div>
    
    <script>
        let structureHistory = [];
        let currentHistoryIndex = -1;
        
        // 互動功能追蹤
        let currentSelectedLine = -1;
        let currentSelectedText = '';
        
        // 組件模板定義
        const componentTemplates = {
            'Header': '├─ Header (固定在頂部)',
            'Toolbar': '├─ Toolbar (操作區)',
            'Sidebar': '├─ Sidebar (側邊欄, width: 300px)',
            'Content': '├─ Content (主要內容)',
            'Footer': '└─ Footer (頁尾)',
            'Container': '├─ Container (max-width: 1200px)',
            'Grid': '├─ Grid Layout (columns: 3, gap: 16px)',
            'Flex': '├─ Flex Container (justify: space-between, align: center)',
            'Button': '  ├─ Button: "按鈕文字" (primary)',
            'Input': '  ├─ Input Field (placeholder: "請輸入...", type: text)',
            'Textarea': '  ├─ Textarea (placeholder: "請輸入內容...", rows: 4)',
            'Select': '  ├─ Select Dropdown (options: [選項1, 選項2, 選項3])',
            'Checkbox': '  ├─ Checkbox: "同意條款"',
            'Radio': '  ├─ Radio Button Group: [選項1, 選項2]',
            'Switch': '  ├─ Toggle Switch: "啟用功能"',
            'Slider': '  ├─ Slider (min: 0, max: 100, value: 50)',
            'Navbar': '├─ Navigation Bar (items: [首頁, 關於, 聯絡])',
            'Menu': '├─ Menu (vertical)',
            'Tabs': '├─ Tabs (tabs: [標籤1, 標籤2, 標籤3])',
            'Breadcrumb': '├─ Breadcrumb (path: 首頁 > 分類 > 頁面)',
            'Pagination': '├─ Pagination (total: 100, perPage: 20)',
            'Stepper': '├─ Stepper (steps: [步驟1, 步驟2, 步驟3], current: 1)',
            'Table': '  ├─ Table (columns: [欄位1, 欄位2, 欄位3])',
            'List': '  ├─ List (items: [項目1, 項目2, 項目3])',
            'Card': '  ├─ Card (title: "卡片標題")',
            'Avatar': '  ├─ Avatar (size: 48px, src: "user.jpg")',
            'Badge': '  ├─ Badge: "新" (color: primary)',
            'Chip': '  ├─ Chip: "標籤" (closable: true)',
            'Tag': '  ├─ Tag: "分類" (color: blue)',
            'Timeline': '├─ Timeline (items: [事件1, 事件2, 事件3])',
            'Alert': '├─ Alert: "提示訊息" (type: info)',
            'Toast': '├─ Toast: "操作成功" (type: success, duration: 3000ms)',
            'Modal': '  ├─ Modal Dialog (title: "標題", width: 500px)',
            'Drawer': '  ├─ Drawer (position: right, width: 400px)',
            'Tooltip': '  ├─ Tooltip: "提示文字"',
            'Popover': '  ├─ Popover (trigger: click)',
            'Progress': '  ├─ Progress Bar (value: 60%, color: primary)',
            'Spinner': '  ├─ Loading Spinner (size: medium)',
            'Skeleton': '  ├─ Skeleton Loader (rows: 3)',
            'Dropdown': '  ├─ Dropdown Menu (items: [選項1, 選項2])',
            'Accordion': '├─ Accordion (panels: [面板1, 面板2])',
            'Carousel': '├─ Carousel (items: 3, autoplay: true)',
            'Divider': '├─ Divider (orientation: horizontal)',
            'Icon': '  ├─ Icon: "home" (size: 24px)',
            'Image': '  ├─ Image (src: "image.jpg", alt: "描述")',
            'Video': '  ├─ Video Player (src: "video.mp4", controls: true)',
            'Form': '├─ Form (method: POST)'
        };
        
        // 添加組件
        function addComponent(type) {
            const structure = document.getElementById('structure');
            const line = componentTemplates[type] || `├─ ${type}`;
            
            if (structure.value) {
                structure.value += '\n' + line;
            } else {
                structure.value = line;
            }
            
            updateStats();
            saveHistory();
        }
        
        // 更新統計
        function updateStats() {
            const structure = document.getElementById('structure').value;
            const lines = structure.split('\n').filter(l => l.trim());
            document.getElementById('line-count').textContent = `${lines.length} 行`;
            document.getElementById('component-count').textContent = `${lines.length} 組件`;
        }
        
        // 監聽文字框變化
        document.getElementById('structure').addEventListener('input', updateStats);
        
        // 儲存歷史記錄
        function saveHistory() {
            const structure = document.getElementById('structure').value;
            structureHistory = structureHistory.slice(0, currentHistoryIndex + 1);
            structureHistory.push(structure);
            currentHistoryIndex++;
        }
        
        // 復原
        function undo() {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                document.getElementById('structure').value = structureHistory[currentHistoryIndex];
                updateStats();
            } else {
                alert('沒有可復原的操作了');
            }
        }
        
        // ===== 互動功能相關函數 =====
        
        // 監聽結構文字框的選擇變化
        document.getElementById('structure').addEventListener('select', updateSelectionInfo);
        document.getElementById('structure').addEventListener('click', updateSelectionInfo);
        
        function updateSelectionInfo() {
            const textarea = document.getElementById('structure');
            const selectionInfo = document.getElementById('selectionInfo');
            
            // 獲取游標位置
            const cursorPos = textarea.selectionStart;
            const text = textarea.value;
            
            // 找到當前行
            const beforeCursor = text.substring(0, cursorPos);
            const currentLine = beforeCursor.split('\n').length;
            
            // 獲取當前行的內容
            const lines = text.split('\n');
            const lineText = lines[currentLine - 1] || '';
            
            if (lineText.trim()) {
                currentSelectedLine = currentLine - 1;
                currentSelectedText = lineText;
                selectionInfo.classList.remove('hidden');
                selectionInfo.innerHTML = `📍 已選擇第 ${currentLine} 行: <code>${lineText.substring(0, 40)}${lineText.length > 40 ? '...' : ''}</code>`;
            } else {
                currentSelectedLine = -1;
                currentSelectedText = '';
                selectionInfo.classList.add('hidden');
                selectionInfo.innerHTML = '📍 未選擇任何行';
            }
        }
        
        // 添加互動功能
        function addInteraction(interactionType) {
            if (currentSelectedLine === -1) {
                alert('⚠️ 請先在右側結構中點擊或選擇要添加功能的行！');
                return;
            }
            
            const textarea = document.getElementById('structure');
            const lines = textarea.value.split('\n');
            let line = lines[currentSelectedLine];
            
            if (!line.trim()) {
                alert('⚠️ 選中的行為空，無法添加功能！');
                return;
            }
            
            // 檢查是否已經有括號
            const hasParenthesis = line.includes('(');
            const functionName = `handle${interactionType.charAt(2).toUpperCase()}${interactionType.slice(3)}`;
            
            // 檢查是否已經有此功能
            if (line.includes(interactionType)) {
                alert(`⚠️ 此行已經有 ${interactionType} 功能了！`);
                return;
            }
            
            // 添加功能標記
            if (hasParenthesis) {
                // 已有括號，在括號內添加
                line = line.replace(/\)(?!.*\))/g, `, ${interactionType}: ${functionName})`);
            } else {
                // 沒有括號，添加新括號
                line = line.trimEnd() + ` (${interactionType}: ${functionName})`;
            }
            
            lines[currentSelectedLine] = line;
            textarea.value = lines.join('\n');
            
            // 更新顯示和保存歷史
            updateStats();
            saveHistory();
            updateSelectionInfo();
            
            // 視覺反饋
            highlightInteractionButton(interactionType);
            
            alert(`✅ 已添加 ${interactionType} 功能到第 ${currentSelectedLine + 1} 行！`);
        }
        
        // 移除當前行的所有互動功能
        function removeInteractions() {
            if (currentSelectedLine === -1) {
                alert('⚠️ 請先在右側結構中點擊或選擇要移除功能的行！');
                return;
            }
            
            const textarea = document.getElementById('structure');
            const lines = textarea.value.split('\n');
            let line = lines[currentSelectedLine];
            
            // 移除所有 on* 功能標記
            line = line.replace(/,\s*(on\w+):\s*\w+/g, '');
            line = line.replace(/\((on\w+):\s*\w+\)/g, '');
            line = line.replace(/\((on\w+):\s*\w+,\s*/g, '(');
            
            // 清理空括號
            line = line.replace(/\(\s*\)/g, '');
            line = line.replace(/\(\s*,/g, '(');
            line = line.replace(/,\s*\)/g, ')');
            
            lines[currentSelectedLine] = line;
            textarea.value = lines.join('\n');
            
            updateStats();
            saveHistory();
            updateSelectionInfo();
            
            alert(`✅ 已移除第 ${currentSelectedLine + 1} 行的所有互動功能！`);
        }
        
        // 高亮顯示當前選擇
        function highlightSelection() {
            if (currentSelectedLine === -1) {
                alert('⚠️ 請先在右側結構中點擊或選擇一行！');
                return;
            }
            
            const textarea = document.getElementById('structure');
            const lines = textarea.value.split('\n');
            
            // 計算選擇範圍
            let start = 0;
            for (let i = 0; i < currentSelectedLine; i++) {
                start += lines[i].length + 1; // +1 for newline
            }
            const end = start + lines[currentSelectedLine].length;
            
            // 選中並聚焦
            textarea.focus();
            textarea.setSelectionRange(start, end);
            
            // 滾動到可見區域
            const lineHeight = 24; // 估計的行高
            textarea.scrollTop = currentSelectedLine * lineHeight - textarea.clientHeight / 2;
        }
        
        // 高亮互動按鈕（視覺反饋）
        function highlightInteractionButton(interactionType) {
            const buttons = document.querySelectorAll('.interaction-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes(interactionType)) {
                    btn.classList.add('selected');
                    setTimeout(() => {
                        btn.classList.remove('selected');
                    }, 500);
                }
            });
        }
        
        // ===== 互動功能相關函數結束 =====
        
        // 產生規格
        function generateSpec() {
            const pageName = document.getElementById('pageName').value;
            const structure = document.getElementById('structure').value;
            
            if (!structure.trim()) {
                alert('請先添加一些組件！');
                return;
            }
            
            // 產生各種格式
            generateVisual(pageName, structure);
            document.getElementById('ascii-pre').textContent = generateASCII(pageName, structure);
            document.getElementById('spec-pre').textContent = generateAISpec(pageName, structure);
            document.getElementById('json-pre').textContent = generateJSON(pageName, structure);
            document.getElementById('gherkin-pre').textContent = generateGherkin(pageName, structure);
            
            alert('✅ 規格已產生！切換到其他標籤查看結果');
        }

        // 產生視覺化 - ASCII 版本（改進版）
        function generateVisual(pageName, structure) {
            const container = document.getElementById('visual-container');
            const lines = structure.split('\n').filter(l => l.trim());
            
            const width = 62;
            let output = [];
            
            // 頂部標題
            output.push('╔' + '═'.repeat(width) + '╗');
            output.push('║' + center(`📄 ${pageName}`, width) + '║');
            output.push('╠' + '═'.repeat(width) + '╣');
            output.push('║' + ' '.repeat(width) + '║');
            
            // 用於追蹤連續的小組件
            let smallComponentBuffer = [];
            
            // 處理每一行
            lines.forEach((line, index) => {
                const cleaned = line.replace(/[├─└│]/g, '').trim();
                const indent = line.match(/^\s*/)[0].length;
                
                // 提取組件名稱
                let componentName = cleaned;
                let annotation = '';
                let isSmallComponent = false;
                
                // 根據組件類型添加註解和判斷大小
                if (cleaned.includes('Header')) {
                    annotation = ' ← 固定頂部';
                } else if (cleaned.includes('Timeline')) {
                    annotation = ' ← Timeline';
                } else if (cleaned.includes('Toolbar')) {
                    annotation = ' ← Toolbar';
                } else if (cleaned.includes('Navigation') || cleaned.includes('Navbar')) {
                    annotation = ' ← Navigation';
                } else if (cleaned.includes('Table')) {
                    const tableNum = (cleaned.match(/\d+/) || [])[0];
                    annotation = tableNum ? ` ← Table ${tableNum}` : ' ← Table';
                } else if (cleaned.includes('Grid')) {
                    annotation = ' ← Grid';
                } else if (cleaned.includes('Card')) {
                    annotation = ' ← 卡片';
                } else if (cleaned.includes('Image') || cleaned.includes('圖片')) {
                    annotation = ' ← Images';
                } else if (cleaned.includes('Sidebar')) {
                    annotation = ' ← 側邊欄';
                } else if (cleaned.includes('Content')) {
                    annotation = ' ← 內容區';
                } else if (cleaned.includes('Footer')) {
                    annotation = ' ← 頁尾';
                } else if (cleaned.includes('Flex Container')) {
                    annotation = ' ← 彈性佈局';
                } else if (cleaned.includes('Container')) {
                    annotation = ' ← 容器';
                }
                
                // 判斷是否為小型組件（輸入類、開關類）
                if (cleaned.match(/^(Toggle|Checkbox|Radio|Switch|Button|Input|Tooltip|Badge|Chip|Icon|Avatar)[\s:]/i) ||
                    cleaned.match(/^(Drawer|Modal|Dialog|Snackbar|Alert)[\s:(]/i)) {
                    isSmallComponent = true;
                }
                
                // 處理縮排和顯示
                if (indent === 0) {
                    // 先輸出緩存的小組件
                    if (smallComponentBuffer.length > 0) {
                        smallComponentBuffer.forEach(comp => {
                            output.push('║    • ' + comp.padEnd(width - 6) + '║');
                        });
                        smallComponentBuffer = [];
                        output.push('║' + ' '.repeat(width) + '║');
                        output.push('╠' + '═'.repeat(width) + '╣');
                    }
                    
                    // 主要組件
                    if (isSmallComponent) {
                        // 小組件加入緩存
                        smallComponentBuffer.push(componentName);
                    } else if (cleaned.includes('Table') || cleaned.includes('Timeline')) {
                        // 帶框的組件
                        output.push('║  ┌' + '─'.repeat(width - 6) + '┐  ║');
                        const contentLine = '║  │  ' + componentName.padEnd(width - 10) + '│' + annotation.padEnd(0) + ' ║';
                        output.push(contentLine.substring(0, width + 2) + '║');
                        output.push('║  └' + '─'.repeat(width - 6) + '┘  ║');
                        output.push('║' + ' '.repeat(width) + '║');
                        
                        if (index < lines.length - 1) {
                            output.push('╠' + '═'.repeat(width) + '╣');
                        }
                    } else {
                        // 普通大組件
                        const displayText = componentName + annotation;
                        output.push('║  ' + displayText.padEnd(width - 2) + '║');
                        output.push('║' + ' '.repeat(width) + '║');
                        
                        if (index < lines.length - 1) {
                            output.push('╠' + '═'.repeat(width) + '╣');
                        }
                    }
                } else {
                    // 嵌套組件
                    const indentStr = ' '.repeat(Math.min(indent * 2, 6));
                    const displayText = indentStr + '• ' + componentName;
                    output.push('║  ' + displayText.padEnd(width - 2) + '║');
                }
            });
            
            // 輸出剩餘的小組件緩存
            if (smallComponentBuffer.length > 0) {
                smallComponentBuffer.forEach(comp => {
                    output.push('║    • ' + comp.padEnd(width - 6) + '║');
                });
                output.push('║' + ' '.repeat(width) + '║');
            }
            
            // 底部
            output.push('╚' + '═'.repeat(width) + '╝');
            
            container.value = output.join('\n');
        }
        
        // 從視覺化同步到結構輸入
        function syncFromVisual() {
            const visualText = document.getElementById('visual-container').value;
            
            // 解析 ASCII 視覺圖
            const lines = visualText.split('\n');
            let structure = [];
            
            lines.forEach(line => {
                // 提取組件名稱（在 ║ 之間的內容）
                const match = line.match(/║\s*(.+?)\s*(?:←.*)?║/);
                if (match) {
                    let content = match[1].trim();
                    
                    // 跳過空行、分隔線、標題等
                    if (!content || content.includes('═') || content.includes('─') || 
                        content.includes('┌') || content.includes('└') || 
                        content.includes('│') || content.includes('📄')) {
                        return;
                    }
                    
                    // 檢測縮排
                    const indent = match[1].search(/\S/);
                    
                    // 移除前導符號
                    content = content.replace(/^[•\-\*]\s*/, '');
                    
                    // 添加樹狀符號
                    if (indent > 2) {
                        structure.push('  ' + content);
                    } else {
                        structure.push('├─ ' + content);
                    }
                }
            });
            
            if (structure.length > 0) {
                document.getElementById('structure').value = structure.join('\n');
                updateStats();
                saveHistory();
                alert('✅ 已同步到結構輸入區！');
            } else {
                alert('⚠️ 無法從視覺圖中提取結構，請確保格式正確。');
            }
        }
        
        // 匯出視覺化 ASCII
        function exportVisualASCII() {
            const content = document.getElementById('visual-container').value;
            if (!content.trim()) {
                alert('⚠️ 視覺圖為空，請先生成或編輯內容！');
                return;
            }
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ui-visual-ascii.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('✅ 已匯出 ASCII 視覺圖！');
        }
        
        // 重新生成視覺化
        function refreshVisual() {
            const pageName = document.getElementById('pageName').value || '未命名頁面';
            const structure = document.getElementById('structure').value;
            
            if (!structure.trim()) {
                alert('⚠️ 請先在左側輸入頁面結構！');
                return;
            }
            
            generateVisual(pageName, structure);
            alert('✅ 已重新生成視覺圖！');
        }
        
        // 置中文字輔助函數
        function center(text, width) {
            // 計算中文字符（每個佔2個位置）
            let displayWidth = 0;
            for (let char of text) {
                displayWidth += /[\u4e00-\u9fa5]/.test(char) ? 2 : 1;
            }
            
            const padding = Math.max(0, width - displayWidth);
            const left = Math.floor(padding / 2);
            const right = padding - left;
            return ' '.repeat(left) + text + ' '.repeat(right);
        }
        
        // 產生 ASCII 圖
        function generateASCII(pageName, structure) {
            const width = 70;
            let output = [];
            
            output.push('┌' + '─'.repeat(width - 2) + '┐');
            output.push('│' + center(`📄 ${pageName}`, width - 2) + '│');
            output.push('├' + '─'.repeat(width - 2) + '┤');
            
            const lines = structure.split('\n');
            lines.forEach(line => {
                if (line.trim()) {
                    const displayLine = line.length > width - 4 ? line.substring(0, width - 7) + '...' : line;
                    output.push('│ ' + displayLine.padEnd(width - 3) + '│');
                }
            });
            
            output.push('└' + '─'.repeat(width - 2) + '┘');
            
            return output.join('\n');
        }
        
        // 產生 AI 可讀規格
        function generateAISpec(pageName, structure) {
            let spec = `頁面：${pageName}\n\n`;
            spec += 'Layout (佈局)：\n';
            spec += structure;
            spec += '\n\nSpacing (間距)：\n';
            spec += '- padding: 16px\n';
            spec += '- margin: 16px\n';
            spec += '- gutter: 8px\n';
            spec += '\nColor Palette (色板)：\n';
            spec += '- primary: #2563EB\n';
            spec += '- accent: #10B981\n';
            spec += '- error: #EF4444\n';
            spec += '\nInteractive States (互動狀態)：\n';
            spec += '- Hover: 背景變深 5%\n';
            spec += '- Active: 縮放 0.98x\n';
            spec += '- Focus: 藍色 outline 2px\n';
            
            return spec;
        }
        
        // 產生 JSON
        function generateJSON(pageName, structure) {
            const lines = structure.split('\n').filter(l => l.trim());
            const components = lines.map(line => {
                const cleaned = line.replace(/[├─└│]/g, '').trim();
                return { component: cleaned };
            });
            
            return JSON.stringify({
                pageName: pageName,
                version: "2.0",
                components: components,
                theme: {
                    colors: {
                        primary: "#2563EB",
                        accent: "#10B981",
                        error: "#EF4444"
                    },
                    spacing: {
                        padding: "16px",
                        margin: "16px",
                        gutter: "8px"
                    }
                }
            }, null, 2);
        }
        
        // 產生 Gherkin
        function generateGherkin(pageName, structure) {
            let gherkin = `Feature: ${pageName}\n`;
            gherkin += `  作為系統使用者\n`;
            gherkin += `  我想要使用${pageName}\n`;
            gherkin += `  以便完成我的工作\n\n`;
            gherkin += `  Background:\n`;
            gherkin += `    Given 我已經開啟"${pageName}"\n\n`;
            gherkin += `  Scenario: 查看頁面結構\n`;
            
            const lines = structure.split('\n').filter(l => l.trim());
            lines.forEach(line => {
                const cleaned = line.replace(/[├─└│]/g, '').trim();
                gherkin += `    Then 我應該看到 ${cleaned}\n`;
            });
            
            return gherkin;
        }
        
        // 切換標籤
        function switchTab(tab) {
            document.querySelectorAll('.output-tabs button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.output-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tab + '-output').classList.add('active');
        }
        
        // 複製輸出
        function copyOutput(type) {
            let textToCopy = '';
            
            if (type === 'visual') {
                // 複製視覺化的 ASCII 文字（從 textarea）
                const container = document.getElementById('visual-container');
                textToCopy = container.value;
            } else {
                const pre = document.getElementById(type + '-pre');
                textToCopy = pre.textContent;
            }
            
            if (!textToCopy.trim()) {
                alert('⚠️ 內容為空，無法複製！');
                return;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✓ 已複製';
                btn.classList.add('copy-success');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copy-success');
                }, 2000);
            });
        }
        
        // 清空
        function clearAll() {
            if (confirm('確定要清空所有內容嗎？')) {
                document.getElementById('structure').value = '';
                updateStats();
                saveHistory();
            }
        }
        
        // 載入範例 (與之前相同，略)
        function loadExample(type) {
            const examples = {
                'login': {
                    name: '登入頁面',
                    structure: `├─ Container (max-width: 400px)
├─ Card
  ├─ Icon: "logo" (size: 64px)
  ├─ Form
    ├─ Input Field (placeholder: "Email")
    ├─ Input Field (placeholder: "密碼")
    ├─ Button: "登入" (primary)`
                },
                'dashboard': {
                    name: '儀表板',
                    structure: `├─ Header (固定在頂部)
├─ Sidebar (側邊欄, width: 240px)
├─ Content (主要內容)
  ├─ Grid Layout (columns: 3)
    ├─ Card (統計卡片)
    ├─ Card (統計卡片)
    ├─ Card (統計卡片)`
                },
                'form': {
                    name: '表單頁面',
                    structure: `├─ Header
├─ Container (max-width: 600px)
  ├─ Form
    ├─ Input Field (label: "姓名")
    ├─ Input Field (label: "Email")
    ├─ Button: "提交" (primary)`
                },
                'ecommerce': {
                    name: '電商頁面',
                    structure: `├─ Header (固定在頂部)
├─ Navigation Bar (items: [首頁, 商品, 關於])
├─ Grid Layout (columns: 4)
  ├─ Card (產品卡片)
  ├─ Card (產品卡片)
  ├─ Card (產品卡片)`
                },
                'admin': {
                    name: '後台系統',
                    structure: `├─ Header (固定在頂部)
├─ Sidebar (側邊欄, width: 260px)
├─ Content
  ├─ Toolbar (操作區)
  ├─ Table (columns: [編號, 用戶, 狀態])
  ├─ Pagination`
                }
            };
            
            const example = examples[type];
            if (example) {
                document.getElementById('pageName').value = example.name;
                document.getElementById('structure').value = example.structure;
                updateStats();
                saveHistory();
            }
        }
        
        // 初始化
        saveHistory();
        updateStats();
    </script>
</body>
</html>
